name: code-validation

on:
  pull_request:
    branches:
      - dev
  workflow_dispatch:

jobs:
  codevalidate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to compare changes
    
    - name: Check for DELETE/DROP keywords in new code
      run: |
        echo "üîç Checking for DELETE/DROP keywords in newly added code..."
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD) # Get the list of changed files
        if [ -z "$CHANGED_FILES" ]; then
          echo "No files changed in this PR"
          exit 0
        fi
        echo "Changed files: $CHANGED_FILES"

        violations_found=false

        for file in $CHANGED_FILES; do
          if [ -f "$file" ]; then
            echo "Checking file: $file"
            if grep -i -E '\b(DELETE|DROP)\b' "$file"; then
              echo "‚ùå VIOLATION FOUND in $file: DELETE or DROP keyword detected"
              echo "The following lines contain DELETE or DROP keywords:"
              grep -i -n -E '\b(DELETE|DROP)\b' "$file" | while read line; do
                echo "  Line $line"
              done
              violations_found=true
            else
              echo "‚úÖ No DELETE/DROP keywords found in $file"
            fi
          fi
        done

        if [ "$violations_found" = true ]; then
          echo "‚ùå VIOLATIONS FOUND: DELETE or DROP keywords detected in newly added code"
          echo "Please remove DELETE/DROP keywords from your code before merging."
          exit "failure because of DELETE/DROP keywords"
        else
          echo "‚úÖ No DELETE/DROP keywords found in newly added code"
        fi
    - name: Additional Security Check
      run: |
        echo "üîí Running additional security checks..."